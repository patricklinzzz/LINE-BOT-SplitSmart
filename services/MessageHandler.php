<?php

require_once __DIR__ . '/../models/DbConnection.php';
require_once __DIR__ . '/../models/Member.php';
require_once __DIR__ . '/../services/BillService.php';
require_once __DIR__ . '/../config/linebot.php';

class MessageHandler
{
  // ËôïÁêÜÊñáÂ≠óË®äÊÅØ
  public static function handleText($userMessage, $groupId)
  {
    $db = DbConnection::getInstance();
    $whitelist_enabled_row = $db->query("SELECT setting_value FROM bot_settings WHERE setting_key = 'whitelist_enabled'")->fetch_assoc();
    if ($whitelist_enabled_row && $whitelist_enabled_row['setting_value'] === 'true') {
      $stmt = $db->prepare("SELECT status FROM group_whitelist WHERE group_id = ?");
      $stmt->bind_param("s", $groupId);
      $stmt->execute();
      $group_row = $stmt->get_result()->fetch_assoc();
      $stmt->close();

      if (!$group_row || $group_row['status'] !== 'approved') {
        return [
          'type' => 'text',
          'text' => 'Êú¨Áæ§ÁµÑÂ∞öÊú™ÈÄöÈÅéÂØ©Ê†∏ÔºåÁÑ°Ê≥ï‰ΩøÁî®Ê≠§ÂäüËÉΩ„ÄÇ'
        ];
      }
    }
    $fullLiffUrl_add = 'https://liff.line.me/2008005425-w5zrAGqk' . '?groupId=' . urlencode($groupId);
    $fullLiffUrl_get = 'https://liff.line.me/2008005425-9w3Ydy41' . '?groupId=' . urlencode($groupId);
    if ($userMessage === '/ÂàÜÂ∏≥') {
      $flexMessageJson = '{
      "type": "bubble",
      "size": "deca",
      "header": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "ÂàÜÂ∏≥Â∞èÂπ´Êâã",
            "weight": "bold",
            "size": "xxl",
            "align": "center",
            "color": "#333333"
          }
        ],
        "justifyContent": "center",
        "alignItems": "center"
      },
      "body": {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "text",
            "text": "„Äå ÈªûÊìäÂä†ÂÖ•ÔºåÈñãÂßãÂàÜÂ∏≥ „Äç",
            "align": "center",
            "color": "#888888",
            "size": "md",
            "weight": "bold",
            "offsetTop": "8px"
          },
          {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "text",
                "text": "üë§ Âä†ÂÖ•ÂêçÂñÆ ",
                "size": "sm",
                "align": "center",
                "color": "#6fa8dc",
                "weight": "bold"
              }
            ],
            "width": "120px",
            "borderWidth": "medium",
            "borderColor": "#6fa8dc",
            "cornerRadius": "xxl",
            "justifyContent": "center",
            "alignItems": "center",
            "height": "30px",
            "margin": "md",
            "action": {
              "type": "postback",
              "label": "action",
              "data": "register_member"
            }
          },
          {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "Ôºã Êñ∞Â¢ûÂ∏≥ÂñÆ",
                    "color": "#FFFFFF",
                    "weight": "bold",
                    "size": "lg"
                  }
                ],
                "backgroundColor": "#2c3e50",
                "width": "180px",
                "justifyContent": "center",
                "alignItems": "center",
                "cornerRadius": "md",
                "height": "40px",
                "action": {
                  "type": "uri",
                  "label": "action",
                  "uri": "' . $fullLiffUrl_add . '"
                }
              },
              {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "üîçÊü•ÁúãÂ∏≥ÂñÆ",
                    "color": "#FFFFFF",
                    "weight": "bold",
                    "size": "lg"
                  }
                ],
                "backgroundColor": "#6fa8dc",
                "width": "180px",
                "justifyContent": "center",
                "alignItems": "center",
                "cornerRadius": "md",
                "height": "40px",
                "action": {
                  "type": "uri",
                  "label": "action",
                  "uri": "' . $fullLiffUrl_get . '"
                }
              },
              {
                "type": "box",
                "layout": "vertical",
                "contents": [
                  {
                    "type": "text",
                    "text": "‚úÖÁµêÁÆó",
                    "color": "#FFFFFF",
                    "size": "lg",
                    "weight": "bold"
                  }
                ],
                "backgroundColor": "#00a8a8",
                "width": "180px",
                "height": "40px",
                "cornerRadius": "md",
                "justifyContent": "center",
                "alignItems": "center",
                "action": {
                  "type": "postback",
                  "label": "action",
                  "data": "get_balance"
                }
              }
            ],
            "height": "160px",
            "justifyContent": "flex-end",
            "spacing": "lg"
          }
        ],
        "alignItems": "center",
        "justifyContent": "center",
        "spacing": "md",
        "backgroundColor": "#eff2f6"
      }
    }';

      $flexMessageArray = json_decode($flexMessageJson, true);

      return [
        'type' => 'flex',
        'altText' => 'ÂàÜÂ∏≥Â∞èÂπ´ÊâãÈÅ∏ÂñÆ',
        'contents' => $flexMessageArray
      ];
    } else {
      return null;
    }
  }
  // ËôïÁêÜpostback
  public static function handlePostback($data, $groupId, $userId)
  {
    parse_str($data, $postbackParams);
    $action = $postbackParams['action'] ?? $data;

    switch ($action) {
      case 'register_member':
        try {
          $db = DbConnection::getInstance();
          $result = Member::registerMember($db, $groupId, $userId);
          $profile = self::getProfile($userId); // ÂèñÂæó‰ΩøÁî®ËÄÖË≥áË®ä
          $displayName = $profile ? $profile['displayName'] : '‰ΩøÁî®ËÄÖ';
          return [
            'type' => 'text',
            'text' => $result ? $displayName . " Âä†ÂÖ•ÊàêÂäüÔºÅ" : $displayName . " Â∑≤Á∂ìÂä†ÂÖ•ÈÅé‰∫Ü„ÄÇ"
          ];
        } catch (Exception $e) {
          error_log('Error in register_member postback: ' . $e->getMessage());
          return [
            'type' => 'text',
            'text' => 'Ë´ãÂú®Áæ§ÁµÑÂÖß‰ΩøÁî®„ÄÇ'
          ];
        }

      case 'get_balance':
        try {
          $db = DbConnection::getInstance();
          $balances = BillService::getFinalBalance($db, $groupId);

          // Â¶ÇÊûúÊ≤íÊúâ‰ªª‰ΩïÂæÖÁµêÁÆóÈ§òÈ°çÔºåÁõ¥Êé•ÂõûÂÇ≥Ë®äÊÅØ
          if (empty($balances)) {
            return ['type' => 'text', 'text' => 'ÁõÆÂâçÊ≤íÊúâ‰ªª‰ΩïÂ∏≥ÂñÆÂèØ‰ª•ÁµêÁÆó„ÄÇ'];
          }

          $transactions = BillService::calculateSettlementTransactions($balances);
          $reportMessage = BillService::createBalanceReportFlexMessage($balances, $transactions);
          return $reportMessage;
        } catch (Exception $e) {
          error_log('Error in get_balance postback: ' . $e->getMessage());
          return [
            'type' => 'text',
            'text' => 'ÁµêÁÆóÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶ÊàñËÅØÁµ°ÁÆ°ÁêÜÂì°„ÄÇ'
          ];
        }

      case 'settle_up':
        $db = DbConnection::getInstance();
        BillService::settleBills($db, $groupId);

        return [
          'type' => 'text',
          'text' => 'Â∏≥ÂñÆÂ∑≤ÊàêÂäüÁµêÁÆóÔºÅ'
        ];

      case 'approve_group':
        $targetGroupId = $postbackParams['groupId'];
        $db = DbConnection::getInstance();
        $stmt = $db->prepare("UPDATE group_whitelist SET status = 'approved' WHERE group_id = ?");
        $stmt->bind_param("s", $targetGroupId);
        $stmt->execute();

        self::sendPushMessage($targetGroupId, ['type' => 'text', 'text' => 'ÊÅ≠ÂñúÔºÅÊú¨Áæ§ÁµÑÂ∑≤ÈÄöÈÅéÂØ©Ê†∏ÔºåÊÇ®ÁèæÂú®ÂèØ‰ª•ÈñãÂßã‰ΩøÁî®ÊâÄÊúâÂäüËÉΩ‰∫Ü„ÄÇËº∏ÂÖ• /ÂàÜÂ∏≥ ‰æÜÊü•ÁúãÈÅ∏ÂñÆ„ÄÇ']);
        return ['type' => 'text', 'text' => "Áæ§ÁµÑ {$targetGroupId} Â∑≤Ê†∏ÂáÜ„ÄÇ"];

      case 'deny_group':
        $targetGroupId = $postbackParams['groupId'];
        $db = DbConnection::getInstance();
        $stmt = $db->prepare("UPDATE group_whitelist SET status = 'denied' WHERE group_id = ?");
        $stmt->bind_param("s", $targetGroupId);
        $stmt->execute();

        self::sendPushMessage($targetGroupId, ['type' => 'text', 'text' => 'ÂæàÊä±Ê≠âÔºåÊÇ®ÁöÑÁæ§ÁµÑÊú™ÈÄöÈÅéÂØ©Ê†∏ÔºåÊ©üÂô®‰∫∫Âç≥Â∞áÈõ¢Èñã„ÄÇ']);
        self::leaveGroup($targetGroupId);
        return ['type' => 'text', 'text' => "Áæ§ÁµÑ {$targetGroupId} Â∑≤ÊãíÁµï‰∏¶ÁßªÈô§„ÄÇ"];

      default:
        return [
          'type' => 'text',
          'text' => 'ÁÑ°Ê≥ïË≠òÂà•ÁöÑÊåá‰ª§„ÄÇ'
        ];
    }
  }
  // ÂèñÂæó‰ΩøÁî®ËÄÖ
  public static function getProfile($userId)
  {
    if (!defined('LINE_CHANNEL_ACCESS_TOKEN') || empty(LINE_CHANNEL_ACCESS_TOKEN)) {
      error_log('LINE_CHANNEL_ACCESS_TOKEN is not defined or empty.');
      return null;
    }

    $url = "https://api.line.me/v2/bot/profile/" . urlencode($userId);

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FAILONERROR, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
      'Authorization: Bearer ' . LINE_CHANNEL_ACCESS_TOKEN
    ]);

    $response = curl_exec($ch);

    if (curl_errno($ch)) {
      error_log('cURL error when getting profile for ' . $userId . ': ' . curl_error($ch));
      curl_close($ch);
      return null;
    }

    curl_close($ch);

    $profile = json_decode($response, true);

    if (json_last_error() !== JSON_ERROR_NONE || !isset($profile['displayName'])) {
      error_log('Failed to decode profile JSON or missing displayName for userId: ' . $userId);
      return null;
    }

    return $profile;
  }
  // Êñ∞Â¢ûÂ∏≥ÂñÆÂæåÔºåÂÇ≥ÈÄÅÊòéÁ¥∞Âà∞Áæ§ÁµÑ
  public static function sendPushMessage($groupId, $flexMessage)
  {
    require_once __DIR__ . '/../config/linebot.php';

    $replyData = [
      'to' => $groupId,
      'messages' => [$flexMessage]
    ];

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'https://api.line.me/v2/bot/message/push');
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'POST');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($replyData));
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
      'Content-Type: application/json',
      'Authorization: Bearer ' . LINE_CHANNEL_ACCESS_TOKEN
    ]);
    curl_exec($ch);
    curl_close($ch);
  }
  // ËÆìÊ©üÂô®‰∫∫Èõ¢ÈñãÁæ§ÁµÑ
  public static function leaveGroup($groupId)
  {
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'https://api.line.me/v2/bot/group/' . $groupId . '/leave');
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
      'Authorization: Bearer ' . LINE_CHANNEL_ACCESS_TOKEN
    ]);
    curl_exec($ch);
    curl_close($ch);
  }
  // ËôïÁêÜÊ©üÂô®‰∫∫Ë¢´Âä†ÂÖ•Áæ§ÁµÑ‰∫ã‰ª∂
  public static function handleJoinEvent($groupId)
  {
    $db = DbConnection::getInstance();
    $whitelist_enabled_row = $db->query("SELECT setting_value FROM bot_settings WHERE setting_key = 'whitelist_enabled'")->fetch_assoc();

    if (!$whitelist_enabled_row || $whitelist_enabled_row['setting_value'] !== 'true') {
      self::sendPushMessage($groupId, ['type' => 'text', 'text' => 'ÊÑüË¨ùÈÇÄË´ãÔºÅËº∏ÂÖ• /ÂàÜÂ∏≥ ‰æÜÊü•ÁúãÂäüËÉΩÈÅ∏ÂñÆ„ÄÇ']);
      return;
    }

    // Whitelist is enabled, start the approval process
    $stmt = $db->prepare("INSERT INTO group_whitelist (group_id, status) VALUES (?, 'pending') ON DUPLICATE KEY UPDATE status = 'pending'");
    $stmt->bind_param("s", $groupId);
    $stmt->execute();
    $stmt->close();

    // Notify the group
    self::sendPushMessage($groupId, ['type' => 'text', 'text' => 'ÊÑüË¨ùÊÇ®ÁöÑÈÇÄË´ãÔºÅÊú¨Áæ§ÁµÑÂ∑≤Êèê‰∫§ÂØ©Ê†∏ÔºåÁÆ°ÁêÜÂì°Â∞áÁõ°Âø´ËôïÁêÜ„ÄÇ']);

    // Notify the admin
    $adminMessage = [
      'type' => 'flex',
      'altText' => 'Êñ∞Áæ§ÁµÑÂØ©Ê†∏Ë´ãÊ±Ç',
      'contents' => [
        'type' => 'bubble',
        'header' => ['type' => 'box', 'layout' => 'vertical', 'contents' => [['type' => 'text', 'text' => 'Êñ∞Áæ§ÁµÑÂØ©Ê†∏Ë´ãÊ±Ç', 'weight' => 'bold', 'size' => 'lg']]],
        'body' => [
          'type' => 'box',
          'layout' => 'vertical',
          'spacing' => 'md',
          'contents' => [
            ['type' => 'text', 'text' => '‰∏ÄÂÄãÊñ∞ÁöÑÁæ§ÁµÑÊ≠£Âú®Á≠âÂæÖÊÇ®ÁöÑÂØ©Ê†∏„ÄÇ', 'wrap' => true],
            ['type' => 'separator'],
            ['type' => 'box', 'layout' => 'baseline', 'contents' => [
              ['type' => 'text', 'text' => 'Áæ§ÁµÑID', 'flex' => 2, 'color' => '#aaaaaa'],
              ['type' => 'text', 'text' => $groupId, 'flex' => 5, 'wrap' => true]
            ]]
          ]
        ],
        'footer' => [
          'type' => 'box',
          'layout' => 'horizontal',
          'spacing' => 'sm',
          'contents' => [
            ['type' => 'button', 'style' => 'primary', 'color' => '#27ae60', 'action' => [
              'type' => 'postback',
              'label' => 'Ê†∏ÂáÜ',
              'data' => 'action=approve_group&groupId=' . $groupId
            ]],
            ['type' => 'button', 'style' => 'primary', 'color' => '#c0392b', 'action' => [
              'type' => 'postback',
              'label' => 'ÊãíÁµï',
              'data' => 'action=deny_group&groupId=' . $groupId
            ]]
          ]
        ]
      ]
    ];

    if (defined('LINE_ADMIN_USER_ID') && !empty(LINE_ADMIN_USER_ID)) {
      self::sendPushMessage(LINE_ADMIN_USER_ID, $adminMessage);
    }
  }
}
